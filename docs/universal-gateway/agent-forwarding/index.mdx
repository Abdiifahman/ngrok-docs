---
title: How Does Agent Forwarding Work?
---

import TabItem from "@theme/TabItem";
import Tabs from "@theme/Tabs";

import { LangSwitcher } from "@site/src/components/LangSwitcher";
import { ContentSwitcher } from "@site/src/components/LangSwitcher/ContentSwitcher";

import RandomAgentCliExample from "/examples/agent-cli/http-random.mdx";
import RandomAgentConfigExample from "/examples/agent-config/http-random.mdx";
import RandomGoSdkExample from "/examples/go-sdk/http-random.mdx";
import RandomJavascriptSdkExample from "/examples/javascript-sdk/http-random.mdx";
import RandomPythonSdkExample from "/examples/python-sdk/http-random.mdx";
import RandomRustSdkExample from "/examples/rust-sdk/http-random.mdx";
import RandomSshExample from "/examples/ssh/http-random.mdx";

import StaticDomainAgentCliExample from "/examples/agent-cli/http-static-domain.mdx";
import StaticDomainAgentConfigExample from "/examples/agent-config/http-static-domain.mdx";
import StaticDomainGoSdkExample from "/examples/go-sdk/http-static-domain.mdx";
import StaticDomainJavascriptSdkExample from "/examples/javascript-sdk/http-static-domain.mdx";
import StaticDomainKubernetesExample from "/examples/k8s/http-static-domain.mdx";
import StaticDomainPythonSdkExample from "/examples/python-sdk/http-static-domain.mdx";
import StaticDomainRustSdkExample from "/examples/rust-sdk/http-static-domain.mdx";
import StaticDomainSshExample from "/examples/ssh/http-static-domain.mdx";

import BrandedDomainAgentCliExample from "/examples/agent-cli/http-branded-domain.mdx";
import BrandedDomainAgentConfigExample from "/examples/agent-config/http-branded-domain.mdx";
import BrandedDomainGoSdkExample from "/examples/go-sdk/http-branded-domain.mdx";
import BrandedDomainJavascriptSdkExample from "/examples/javascript-sdk/http-branded-domain.mdx";
import BrandedDomainKubernetesExample from "/examples/k8s/http-branded-domain.mdx";
import BrandedDomainPythonSdkExample from "/examples/python-sdk/http-branded-domain.mdx";
import BrandedDomainRustSdkExample from "/examples/rust-sdk/http-branded-domain.mdx";
import BrandedDomainSshExample from "/examples/ssh/http-branded-domain.mdx";

import BasicAuthAgentCliExample from "/examples/agent-cli/http-basic-auth.mdx";
import BasicAuthAgentConfigExample from "/examples/agent-config/http-basic-auth.mdx";
import BasicAuthGoSdkExample from "/examples/go-sdk/http-basic-auth.mdx";
import BasicAuthJavascriptSdkExample from "/examples/javascript-sdk/http-basic-auth.mdx";
import BasicAuthKubernetesExample from "/examples/k8s/http-basic-auth.mdx";
import BasicAuthPythonSdkExample from "/examples/python-sdk/http-basic-auth.mdx";
import BasicAuthRustSdkExample from "/examples/rust-sdk/http-basic-auth.mdx";
import BasicAuthSshExample from "/examples/ssh/http-basic-auth.mdx";

import OAuthAgentCliExample from "/examples/agent-cli/http-oauth-authn.mdx";
import OAuthAgentConfigExample from "/examples/agent-config/http-oauth-authn.mdx";
import OAuthGoSdkExample from "/examples/go-sdk/http-oauth-authn.mdx";
import OAuthJavascriptSdkExample from "/examples/javascript-sdk/http-oauth-authn.mdx";
import OAuthKubernetesExample from "/examples/k8s/http-oauth-authn.mdx";
import OAuthPythonSdkExample from "/examples/python-sdk/http-oauth-authn.mdx";
import OAuthRustSdkExample from "/examples/rust-sdk/http-oauth-authn.mdx";
import OAuthSshExample from "/examples/ssh/http-oauth-authn.mdx";

import ForwardHttpsAgentConfigExample from "/examples/agent-config/http-forward-https.mdx";
import ForwardHttpsKubernetesExample from "/examples/k8s/http-forward-https.mdx";

import HostHeaderAgentCliExample from "/examples/agent-cli/http-rewrite-host-header.mdx";
import HostHeaderAgentConfigExample from "/examples/agent-config/http-rewrite-host-header.mdx";
import HostHeaderGoSdkExample from "/examples/go-sdk/http-rewrite-host-header.mdx";
import HostHeaderJavascriptSdkExample from "/examples/javascript-sdk/http-rewrite-host-header.mdx";
import HostHeaderKubernetesExample from "/examples/k8s/http-rewrite-host-header.mdx";
import HostHeaderPythonSdkExample from "/examples/python-sdk/http-rewrite-host-header.mdx";
import HostHeaderRustSdkExample from "/examples/rust-sdk/http-rewrite-host-header.mdx";
import HostHeaderSshExample from "/examples/ssh/http-rewrite-host-header.mdx";

import NonLocalAgentCliExample from "/examples/agent-cli/http-nonlocal.mdx";
import NonLocalGoSdkExample from "/examples/go-sdk/http-nonlocal.mdx";
import NonLocalJavascriptSdkExample from "/examples/javascript-sdk/http-nonlocal.mdx";
import NonLocalPythonSdkExample from "/examples/python-sdk/http-nonlocal.mdx";
import NonLocalRustSdkExample from "/examples/rust-sdk/http-nonlocal.mdx";
import NonLocalSshExample from "/examples/ssh/http-nonlocal.mdx";

import RandomAgentCliExampleTCP from "/examples/agent-cli/tcp-random.mdx";
import RandomAgentConfigExampleTCP from "/examples/agent-config/tcp-random.mdx";
import RandomGoSdkExampleTCP from "/examples/go-sdk/tcp-random.mdx";
import RandomJavascriptSdkExampleTCP from "/examples/javascript-sdk/tcp-random.mdx";
import RandomKubernetesExampleTCP from "/examples/k8s/tcp-random.mdx";
import RandomPythonSdkExampleTCP from "/examples/python-sdk/tcp-random.mdx";
import RandomRustSdkExampleTCP from "/examples/rust-sdk/tcp-random.mdx";
import RandomSshExampleTCP from "/examples/ssh/tcp-random.mdx";

import FixedAgentCliExampleTCP from "/examples/agent-cli/tcp-fixed.mdx";
import FixedAgentConfigExampleTCP from "/examples/agent-config/tcp-fixed.mdx";
import FixedGoSdkExampleTCP from "/examples/go-sdk/tcp-fixed.mdx";
import FixedJavascriptSdkExampleTCP from "/examples/javascript-sdk/tcp-fixed.mdx";
import FixedKubernetesExampleTCP from "/examples/k8s/tcp-fixed.mdx";
import FixedPythonSdkExampleTCP from "/examples/python-sdk/tcp-fixed.mdx";
import FixedRustSdkExampleTCP from "/examples/rust-sdk/tcp-fixed.mdx";
import FixedSshExampleTCP from "/examples/ssh/tcp-fixed.mdx";

import NonLocalAgentCliExampleTCP from "/examples/agent-cli/tcp-nonlocal.mdx";
import NonLocalAgentConfigExampleTCP from "/examples/agent-config/tcp-nonlocal.mdx";
import NonLocalGoSdkExampleTCP from "/examples/go-sdk/tcp-nonlocal.mdx";
import NonLocalJavascriptSdkExampleTCP from "/examples/javascript-sdk/tcp-nonlocal.mdx";
import NonLocalKubernetesExampleTCP from "/examples/k8s/tcp-nonlocal.mdx";
import NonLocalPythonSdkExampleTCP from "/examples/python-sdk/tcp-nonlocal.mdx";
import NonLocalRustSdkExampleTCP from "/examples/rust-sdk/tcp-nonlocal.mdx";
import NonLocalSshExampleTCP from "/examples/ssh/tcp-nonlocal.mdx";

import ProxyProtoAgentCliExample from "/examples/agent-cli/tcp-proxyproto.mdx";
import ProxyProtoAgentConfigExample from "/examples/agent-config/tcp-proxyproto.mdx";
import ProxyProtoGoSdkExample from "/examples/go-sdk/tcp-proxyproto.mdx";
import ProxyProtoJavascriptSdkExample from "/examples/javascript-sdk/tcp-proxyproto.mdx";
import ProxyProtoKubernetesExample from "/examples/k8s/tcp-proxyproto.mdx";
import ProxyProtoPythonSdkExample from "/examples/python-sdk/tcp-proxyproto.mdx";
import ProxyProtoRustSdkExample from "/examples/rust-sdk/tcp-proxyproto.mdx";
import ProxyProtoSshExample from "/examples/ssh/tcp-proxyproto.mdx";

import AtAgentAgentCliExample from "/examples/agent-cli/tls-terminate-at-agent.mdx";
import AtAgentAgentConfigExample from "/examples/agent-config/tls-terminate-at-agent.mdx";
import AtAgentGoSdkExample from "/examples/go-sdk/tls-terminate-at-agent.mdx";
import AtAgentJavascriptSdkExample from "/examples/javascript-sdk/tls-terminate-at-agent.mdx";
import AtAgentKubernetesExample from "/examples/k8s/tls-terminate-at-agent.mdx";
import AtAgentPythonSdkExample from "/examples/python-sdk/tls-terminate-at-agent.mdx";
import AtAgentRustSdkExample from "/examples/rust-sdk/tls-terminate-at-agent.mdx";
import AtAgentSshExample from "/examples/ssh/tls-terminate-at-agent.mdx";

import AtUpstreamAgentCliExample from "/examples/agent-cli/tls-terminate-at-upstream.mdx";
import AtUpstreamAgentConfigExample from "/examples/agent-config/tls-terminate-at-upstream.mdx";
import AtUpstreamGoSdkExample from "/examples/go-sdk/tls-terminate-at-upstream.mdx";
import AtUpstreamJavascriptSdkExample from "/examples/javascript-sdk/tls-terminate-at-upstream.mdx";
import AtUpstreamKubernetesExample from "/examples/k8s/tls-terminate-at-upstream.mdx";
import AtUpstreamPythonSdkExample from "/examples/python-sdk/tls-terminate-at-upstream.mdx";
import AtUpstreamRustSdkExample from "/examples/rust-sdk/tls-terminate-at-upstream.mdx";
import AtUpstreamSshExample from "/examples/ssh/tls-terminate-at-upstream.mdx";

import CustomDomainAgentCliExample from "/examples/agent-cli/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainAgentConfigExample from "/examples/agent-config/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainGoSdkExample from "/examples/go-sdk/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainJavascriptSdkExample from "/examples/javascript-sdk/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainKubernetesExample from "/examples/k8s/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainPythonSdkExample from "/examples/python-sdk/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainRustSdkExample from "/examples/rust-sdk/tls-terminate-at-edge-custom-domain.mdx";
import CustomDomainSshExample from "/examples/ssh/tls-terminate-at-edge-custom-domain.mdx";

import ReencryptUpstreamAgentCliExample from "/examples/agent-cli/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamAgentConfigExample from "/examples/agent-config/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamGoSdkExample from "/examples/go-sdk/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamJavascriptSdkExample from "/examples/javascript-sdk/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamKubernetesExample from "/examples/k8s/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamPythonSdkExample from "/examples/python-sdk/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamRustSdkExample from "/examples/rust-sdk/tls-reencrypt-upstream.mdx";
import ReencryptUpstreamSshExample from "/examples/ssh/tls-reencrypt-upstream.mdx";

import ProxyProtoAgentCliExampleTLS from "/examples/agent-cli/tls-proxyproto.mdx";
import ProxyProtoAgentConfigExampleTLS from "/examples/agent-config/tls-proxyproto.mdx";
import ProxyProtoGoSdkExampleTLS from "/examples/go-sdk/tls-proxyproto.mdx";
import ProxyProtoJavascriptSdkExampleTLS from "/examples/javascript-sdk/tls-proxyproto.mdx";
import ProxyProtoKubernetesExampleTLS from "/examples/k8s/tls-proxyproto.mdx";
import ProxyProtoPythonSdkExampleTLS from "/examples/python-sdk/tls-proxyproto.mdx";
import ProxyProtoRustSdkExampleTLS from "/examples/rust-sdk/tls-proxyproto.mdx";
import ProxyProtoSshExampleTLS from "/examples/ssh/tls-proxyproto.mdx";

The [ngrok agent](/agent/) and [Agent SDKs](/agent-sdks/) forward traffic that your endpoints receive to upstream services. You specify a URL or port number to instruct the ngrok agent where and how to forward traffic.

:::note
This page covers forwarding traffic to upstream resources. If you specifically want to forward traffic from one endpoint to another, [use Traffic Policy](/universal-gateway/chain-endpoints).
:::

## HTTPS forwarding

The scheme in your upstream URL is used to determine whether to forward HTTP or HTTPS traffic to the upstream service. If you do not specify a scheme, the default `http` scheme is chosen _unless_ you forward to port `443`, in which case ngrok will use `https`. Consult the following table of examples.

| Upstream URL             | Normalized Value         |
| ------------------------ | ------------------------ |
| `http://localhost:1234`  | `http://localhost:1234`  |
| `https://localhost:1234` | `https://localhost:1234` |
| `localhost:1234`         | `http://localhost:1234`  |
| `1234`                   | `http://localhost:1234`  |
| `localhost:443`          | `https://localhost:443`  |
| `443`                    | `https://localhost:443`  |

ngrok assumes that the network you run the agent on is private and it does not verify the TLS certificate presented by the upstream service. You may change this behavior with the [flags `--upstream-tls-verify` and `upstream-tls-verify-cas`](/agent/cli/#ngrok-http).

:::info
Forwarding to an upstream HTTPS service is not supported via SSH.
:::

<Tabs groupId="endpoint-type" queryString="ept">
<TabItem value="agent-endpoint" label="Agent Endpoint" default>
<LangSwitcher>
```bash
ngrok http https://localhost:8443
```

```go
import (
	"context"
	"net/url"

    "golang.ngrok.com/ngrok"
    "golang.ngrok.com/ngrok/config"

)

func ngrokForwarder(ctx context.Context) (ngrok.Forwarder, error) {
backendUrl, err := url.Parse("https://localhost:8443")
if err != nil {
return nil, err
}

    return ngrok.ListenAndForward(ctx,
    	backendUrl,
    	config.HTTPEndpoint(),
    	ngrok.WithAuthtokenFromEnv(),
    )

}
```

```jsx
const ngrok = require("@ngrok/ngrok");

(async function () {
	const listener = await ngrok.forward({
		addr: "https://localhost:8443",
		authtoken_from_env: true,
	});

	console.log(`Ingress established at: ${listener.url()}`);
})();
```

```python
import ngrok

listener = ngrok.forward("https://localhost:8443", authtoken_from_env=True)

print(f"Ingress established at: {listener.url()}");
```

```rust
use ngrok::prelude::*;
use ngrok::tunnel;
use ngrok::forwarder::Forwarder;
use url::Url;

async fn forward_ngrok() -> Result<Forwarder<tunnel::HttpTunnel>, Error> {
    let sess = ngrok::Session::builder()
        .authtoken_from_env()
        .connect()
        .await?;
    sess
        .http_endpoint()
        .listen_and_forward(Url::parse("https://localhost:8443")?)
        .await
        .map_err(Into::into)
}
```

</LangSwitcher>

</TabItem>

<TabItem value="k8s" label="Kubernetes Controller">
	<ForwardHttpsKubernetesExample />
</TabItem>
<TabItem value="agent-config" label="Agent Config">
	<ForwardHttpsAgentConfigExample />
</TabItem>

</Tabs>

<ContentSwitcher languages={["go"]}>

:::note
For HTTP/2 Use: `config.HTTPEndpoint(config.WithAppProtocol("http2"))`
:::

</ContentSwitcher>

### HTTP/2 forwarding

When agents forward to upstream http/2 services, connections use HTTP/1.1 by
default.

You can configure the agent, SDKs and Kubernetes Operator to instead use HTTP/2
when forwarding to your upstream service.

| Forwarder           | Option                            | Docs                                      |
| ------------------- | --------------------------------- | ----------------------------------------- |
| Agent               | `--upstream-protocol`             | [Agent CLI flags](/agent/cli/#ngrok-http) |
| Agent SDKs          | language-dependent                | [Agent SDKs](/agent-sdks)                 |
| Kubernetes Operator | `appProtocol` on the `Tunnel` CRD | [Kubernetes Operator](/k8s)               |

When http2 forwarding is enabled, all requests to your upstream service will be
transmitted over HTTP/2 Cleartext since TLS was already terminated at the ngrok
cloud service. We cannot use
[TLS-ALPN](https://httpwg.org/specs/rfc7540.html#TLS-ALPN) at this time. We
rely on [HTTP/2 with Prior
Knowledge](https://httpwg.org/specs/rfc7540.html#known-http) currently.

### How do I encrypt traffic forwarded to upstream services?

If you terminate TLS at the ngrok cloud service or ngrok agent, you may want to
re-encrypt the connection from the agent to your upstream service. The ngrok
agent supports this behavior by using the non-standard `tls://` scheme syntax.

<Tabs groupId="endpoint-type" queryString="ept">
<TabItem value="agent-endpoint" label="Agent Endpoint" default>

<LangSwitcher>
```bash
ngrok tls tls://localhost:443 --terminate-at=edge
```

```python
import ngrok

listener = ngrok.forward("tls://localhost:443", authtoken_from_env=True,
    proto="tls"
    crt=bytearray(),
    key=bytearray())

print(f"Ingress established at: {listener.url()}");
```

</LangSwitcher>

<ContentSwitcher languages={["python"]}>
	An empty certificate and key will default to the ngrok edge's automatically
	provisioned keypair. The upstream certificate of `localhost:443` will be
	validated by a filepath specified in the `SSL_CERT_FILE` environment variable
	(e.g. `SSL_CERT_FILE=/path/to/ca.crt`), or falling back to the host OS
	installed trusted certificate authorities.
</ContentSwitcher>

</TabItem>
<TabItem value="javascript-sdk" label="Javascript">
<ReencryptUpstreamJavascriptSdkExample />
</TabItem>
<TabItem value="python-sdk" label="Python">
<ReencryptUpstreamPythonSdkExample />
</TabItem>
<TabItem value="agent-config" label="Agent Config">
<ReencryptUpstreamAgentConfigExample />
</TabItem>
<TabItem value="k8s" label="Kubernetes Controller">
<ReencryptUpstreamKubernetesExample />
</TabItem>
</Tabs>

:::info

Re-encrypting the connection to your upstream service with TLS is not supported for:

- SSH
- Go
- Rust

:::
