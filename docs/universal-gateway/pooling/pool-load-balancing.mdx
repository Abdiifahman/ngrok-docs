---
title: Load Balancing With Endpoint Pools
description: Learn about the different load balancing strategies available for endpoint pools with ngrok.
---

import TabItem from "@theme/TabItem";
import Tabs from "@theme/Tabs";

[Endpoint pools](/universal-gateway/pooling) automatically load balance traffic between their endpoints. Load balancing is applied in two places:

- When pooled public and kubernetes endpoints load balance traffic received from external clients.
- When pooled internal endpoints receive traffic that is forwarded to them via the `forward-internal` Traffic Policy action.

### Granularity

ngrok intelligently chooses the load balancing layer automatically for you.

<Tabs groupId="load-balancing-layer" queryString="lb-layer">
<TabItem value="tcp-tls" label="TCP and TLS" default>

Traffic to TCP and TLS endpoints is balanced on a per-connection basis (layer 4).

</TabItem>
<TabItem value="http-s" label="HTTP and HTTPS">

Traffic to HTTP and HTTPS endpoints balanced on a per-request basis (layer 7). If multiple endpoints in a pool have different `on_tcp_connect` phases in their Traffic Policy, load balancing is instead done on a per-connection basis (layer 4).

</TabItem>
</Tabs>

## Default load balancing strategy

ngrok's default balancing strategy attempts to strike a balance between
performance and faireness by prioritizing the following:

1. Identify all endpoints in the pool which are in the [point of presence](/universal-gateway/points-of-presence/) closest to where a connection is received.
1. Balance the connections in a random distribution among those endpoints.

For the purposes of the first step, [cloud endpoints](/universal-gateway/cloud-endpoints) are considered to be online in
all points of presence.

### Example

If an endpoint pool consist of the following endpoints:

- **Endpoint A**: Agent Endpoint connected to `eu`
- **Endpoint B**: Agent Endpoint connected `eu`
- **Endpoint C**: Agent Endpoint connected `us`
- **Endpoint D**: Cloud Endpoint

Then:

- A connection received in `eu` will be balanced among endpoints A, B, D
- A connection received in `us` will be balanced among endpoints C, D
- A connection received in `jp` will be balanced among endpoints D

### Connection retries with load balancing

Currently, there's no support for [connection failover](https://en.wikipedia.org/wiki/Failover) with endpoint pools. Failed connections to an endpoint in a pool are neither retried not sent to other endpoints in the pool.

## Custom Strategies

:::info Coming Soon

Custom load balancing strategies are not yet generally available. [Request access to the developer preview](mailto:support@ngrok.com).

:::

When balancing traffic to internal endpoints, you may define your own balancing strategy by setting the `endpoint_selectors` and `endpoint_weights` fields on the `forward-internal` Traffic Policy action configuration.

## Using Traffic Policy with pools

Endpoints in a pool may have different Traffic Policies. This lets you run old and new Traffic Policies side-by-side during a transition. It also enables you to roll out new Traffic Policy changes without risking an all-or-nothing deployment.

When traffic is balanced among endpoints with different Traffic Policies, ngrok first chooses an endpoint to balance to, then executes the Traffic Policy of the chosen endpoint.
